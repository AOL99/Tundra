/* @author AOL
 * @brief  Sets a maximum pixel width for player messages. Based on a plugin by jdb.
*/
#include "../inc/util.hpp"

static const int MAX_PIXEL_WIDTH = 2060;
static const int DEFAULT_CHAR_WIDTH = 27;

static const int ROCKWELL_WIDTHS[224] = {
    14,
    16,
    22,
    36,
    29,
    52,
    37,
    10,
    20,
    20,
    28,
    36,
    16,
    19,
    16,
    24,
    29,
    29,
    29,
    29,
    29,
    29,
    29,
    29,
    29,
    29,
    16,
    16,
    36,
    36,
    36,
    25,
    55,
    38,
    31,
    41,
    39,
    34,
    30,
    43,
    38,
    17,
    17,
    34,
    28,
    47,
    39,
    43,
    31,
    43,
    33,
    29,
    31,
    37,
    38,
    54,
    35,
    35,
    30,
    20,
    24,
    20,
    25,
    27,
    18,
    29,
    35,
    28,
    34,
    31,
    16,
    34,
    31,
    16,
    16,
    31,
    16,
    47,
    31,
    31,
    34,
    33,
    23,
    25,
    16,
    30,
    29,
    42,
    30,
    30,
    24,
    18,
    28,
    18,
    31,
    27,
    29,
    27,
    16,
    30,
    28,
    54,
    28,
    28,
    18,
    58,
    29,
    16,
    55,
    27,
    30,
    27,
    27,
    16,
    16,
    28,
    28,
    19,
    27,
    54,
    18,
    54,
    25,
    16,
    51,
    27,
    24,
    35,
    14,
    16,
    28,
    29,
    36,
    35,
    28,
    26,
    18,
    40,
    19,
    26,
    36,
    19,
    40,
    18,
    21,
    36,
    18,
    18,
    18,
    30,
    29,
    16,
    18,
    18,
    20,
    26,
    52,
    52,
    52,
    25,
    38,
    38,
    38,
    38,
    38,
    38,
    51,
    41,
    34,
    34,
    34,
    34,
    17,
    17,
    17,
    17,
    39,
    39,
    43,
    43,
    43,
    43,
    43,
    36,
    43,
    37,
    37,
    37,
    37,
    35,
    31,
    35,
    29,
    29,
    29,
    29,
    29,
    29,
    48,
    28,
    31,
    31,
    31,
    31,
    16,
    16,
    16,
    16,
    31,
    31,
    31,
    31,
    31,
    31,
    31,
    36,
    31,
    30,
    30,
    30,
    30,
    30,
    34,
    30
};

static int getRockwellWidth(char* message)
{
    int width = 0;

    char* cur = message;
    while (*cur != '\0')
    {
        width += ROCKWELL_WIDTHS[*cur - 32];
        cur++;
    }

    return width;
}

static Hook PlayerMessageHook(
    &PlayerMessage,
    [](int &playerID, char* &message)
    {
        if (getRockwellWidth(message) > MAX_PIXEL_WIDTH)
        {
            Engine::players[playerID].sendMessage("Message too long");
            return HOOK_OVERRIDE;
        }
        return HOOK_CONTINUE;
    }
);